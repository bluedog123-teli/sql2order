<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>解析 pay_order INSERT 并回显</title>
  <style>
    body{font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"微软雅黑";padding:18px;background:#f7f9fb}
    textarea{width:100%;height:180px;padding:10px;font-family:monospace;font-size:13px}
    .row{display:flex;gap:10px;margin-top:10px}
    .btn{padding:8px 14px;border-radius:6px;border:1px solid #2b78f6;background:#2b78f6;color:#fff;cursor:pointer}
    .result{margin-top:14px;background:#fff;padding:12px;border-radius:8px;border:1px solid #e6eaef}
    table{border-collapse:collapse;width:100%}
    td,th{padding:8px;border-bottom:1px solid #f0f2f5;text-align:left}
    .muted{color:#666;font-size:13px}
    .small{font-size:13px}
    .warning{color:#c0392b}
  </style>
</head>
<body>
  <h2>解析 pay_order 的 INSERT INTO ... VALUES(...) 并回显指定字段</h2>
  <p class="muted">将一条或多条 INSERT 语句粘贴到下面，点击 <strong>解析并回显</strong>。脚本会从每条 VALUES 中解析字段并显示：商务号、系统单号、商户单号、订单金额、产品编码（银行编码-银行名称）、通道（中文通道）、订单状态（含中文说明）。</p>

  <textarea id="sqlInput" placeholder="在此粘贴 INSERT INTO `pay_order` VALUES (...);\n可以粘贴多条，每条换行或分号隔开。示例请粘贴你给我的那条 INSERT。"></textarea>
  <div class="row">
    <button class="btn" id="parseBtn">解析并回显</button>
    <button class="btn" id="clearBtn" style="background:#e0e0e0;color:#111;border-color:#d0d0d0">清空</button>
  </div>

  <div id="output" class="result" style="display:none"></div>

<script>
// 列顺序必须与 CREATE TABLE 中的字段顺序一致（本脚本按照用户给出的表结构顺序来索引）。
// 我们只关心的列索引（从1开始）：
// pay_memberid: 2
// pay_orderid: 5
// out_trade_id: 20
// pay_amount: 6
// pay_bankcode: 11
// pay_bankname: 14
// pay_zh_tongdao: 18
// pay_status: 15

function parseValuesList(valuesText){
  // valuesText 是括号内的部分，不包含 VALUES 或尾部分号
  // 我们按 SQL 字面量解析：支持单引号字符串（内部用两单引号表示转义）和不带引号的数字或空字符串（''）或 NULL
  const tokens = [];
  let i = 0;
  const s = valuesText;
  const n = s.length;
  while(i < n){
    while(i<n && /[\s,]/.test(s[i])) i++;
    if(i>=n) break;
    if(s[i] === "'"){
      // parse quoted string
      i++; let buf = '';
      while(i<n){
        if(s[i] === "'"){
          // check escaped '' -> single '
          if(i+1<n && s[i+1] === "'"){
            buf += "'"; i+=2; continue;
          } else { i++; break; }
        } else {
          buf += s[i++];
        }
      }
      tokens.push(buf);
      // skip possible spaces and comma handled by loop
    } else {
      // parse unquoted token until comma or end
      let buf = '';
      while(i<n && s[i] !== ',') { buf += s[i++]; }
      buf = buf.trim();
      // treat NULL (case-insensitive) as null, otherwise raw
      if(/^NULL$/i.test(buf)) tokens.push(null);
      else if(buf === '') tokens.push('');
      else tokens.push(buf);
    }
    // skip comma if present
    while(i<n && /[\s]/.test(s[i])) i++;
    if(i<n && s[i] === ',') { i++; }
  }
  return tokens;
}

function extractAllInserts(text){
  // 找到所有 VALUES (...) 的括号内容（支持多行）
  const regex = /VALUES\s*\(([^)]*)\)/ig;
  const matches = [];
  let m;
  while((m = regex.exec(text)) !== null){
    matches.push(m[1]);
  }
  return matches;
}

function statusText(code){
  // code 可能是字符串或数字或 null
  const map = {
    '0':'未支付',
    '1':'已支付未回调',
    '2':'已支付已回调',
    '3':'未出单'
  };
  if(code === null || code === undefined || code === '') return '未知';
  const k = String(code).trim();
  return (map.hasOwnProperty(k) ? map[k] : ('未知('+k+')'));
}

function renderResult(rows){
  const out = document.getElementById('output');
  out.style.display = rows.length ? 'block' : 'none';
  if(rows.length === 0){ out.innerHTML = '<div class="warning">没有解析到任何 INSERT ... VALUES(...) 内容。</div>'; return; }
  let html = '<table><thead><tr><th>#</th><th>商务号</th><th>系统单号</th><th>商户单号</th><th>订单金额</th><th>产品编码</th><th>通道</th><th>订单状态</th></tr></thead><tbody>';
  rows.forEach((r, idx)=>{
    html += '<tr>';
    html += '<td>'+(idx+1)+'</td>';
    html += '<td>'+ (r.pay_memberid ?? '') +'</td>';
    html += '<td>'+ (r.pay_orderid ?? '') +'</td>';
    html += '<td>'+ (r.out_trade_id ?? '') +'</td>';
    html += '<td>'+ (r.pay_amount ?? '') +'</td>';
    html += '<td>'+ (r.pay_bankcode??'') + (r.pay_bankname? (' - '+r.pay_bankname): '') +'</td>';
    html += '<td>'+ (r.pay_zh_tongdao ?? '') +'</td>';
    html += '<td>'+ (r.pay_status_display ?? '') + ' (' + (r.pay_status ?? '') + ')</td>';
    html += '</tr>';
  });
  html += '</tbody></table>';
  out.innerHTML = html;
}

document.getElementById('parseBtn').addEventListener('click', ()=>{
  const text = document.getElementById('sqlInput').value;
  const inserts = extractAllInserts(text);
  const rows = [];
  inserts.forEach(valuesText => {
    try{
      const tokens = parseValuesList(valuesText);
      // note: tokens is 0-based; mapping per table definition:
      // index (1-based) -> array index = i-1
      const pick = (i)=> tokens[i-1] === undefined ? null : tokens[i-1];
      const row = {
        pay_memberid: pick(2),
        pay_orderid: pick(5),
        out_trade_id: pick(20),
        pay_amount: pick(6),
        pay_bankcode: pick(11),
        pay_bankname: pick(14),
        pay_zh_tongdao: pick(18),
        pay_status: pick(15)
      };
      row.pay_status_display = statusText(row.pay_status);
      rows.push(row);
    }catch(e){
      console.error('parse error', e);
    }
  });
  renderResult(rows);
});

document.getElementById('clearBtn').addEventListener('click', ()=>{
  document.getElementById('sqlInput').value = '';
  document.getElementById('output').style.display = 'none';
  document.getElementById('output').innerHTML = '';
});

// Demo: 如果你希望页面自动填充用户示例，可以把下面的示例放开（注释掉当前行为）。
//document.getElementById('sqlInput').value = "INSERT INTO `pay_order` VALUES ('18447701', '250884224', '', '', 'DKD09200000066364395457985438', '3.0000', '0.0600', '2.9400', '1758297606', '1758297619', '77', 'https://gate.mzgyb.com/pay/notify/2025092000000653815/', 'https://api.mzgyb.com/pay/return/2025092000000653815/', '支付宝打赏1-300', '2', '时尚小挂件订单41e80f2bbc5f49aab01114ae3da0dece', 'Tvdf7bdx', 'hy打赏', '', '2025092000000653815', '0', '10005', 'ae452daf5c30e76a9b4a8cc847dd083b', '2012', '0', '0', 'Tvdf7bdx', 'zfbh5', '0', '', 'hy通道', '0.0000', '0.0000', '893', '894', '340277748', '0', '0', '337', '0', '0', '0', '0', '', '0.0000', '0.0000', '0');";
//document.getElementById('parseBtn').click();

</script>
  <div id="copyArea" class="result" style="display:none;margin-top:20px;"></div>
  <button class="btn" id="copyBtn" style="display:none;margin-top:10px;">复制格式文本</button>

<script>
  const _oldRender = renderResult;
  renderResult = function(rows){
    _oldRender(rows);
    const copyArea = document.getElementById('copyArea');
    const copyBtn = document.getElementById('copyBtn');
    if(rows.length === 0){ copyArea.style.display='none'; copyBtn.style.display='none'; return; }

    let txt = '';
    rows.forEach(r =>{
      const statusMap = {
        '未支付':'未支付',
        '已支付未回调':'已支付，未回调',
        '已支付已回调':'已支付，已回调'
      };
      const st = statusMap[r.pay_status_display] || r.pay_status_display;
      txt += `商务号：${r.pay_memberid||''}\n系统单号：${r.pay_orderid||''}\n商户单号：${r.out_trade_id||''}\n订单金额：${r.pay_amount||''}\n产品编码：${r.pay_bankcode||''}\n通道：${r.pay_zh_tongdao||''}\n订单状态：${st}\n\n`;
    });
    copyArea.innerText = txt.trim();
    copyArea.style.display='block';
    copyBtn.style.display='inline-block';
  };

  document.getElementById('copyBtn').addEventListener('click', ()=>{
    const txt = document.getElementById('copyArea').innerText;
    navigator.clipboard.writeText(txt);
  });
</script>

</body>
</html>
